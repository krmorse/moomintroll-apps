<!DOCTYPE html>
<html>
<head>
    <title>TS Initiative Percentage View</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CA.agile.technicalservices.util.WsapiUtils",{singleton:!0,loadWsapiRecords:function(e){var t=Ext.create("Deft.Deferred"),r=Ext.Object.merge({autoLoad:!0},e);return Ext.create("Rally.data.wsapi.Store",r).load({callback:function(e,r){r.wasSuccessful()?t.resolve(e):t.reject(r.error.errors.join(","))}}),t.promise},loadSnapshotRecords:function(e){var t=Ext.create("Deft.Deferred"),r=Ext.Object.merge({removeUnauthorizedSnapshots:!0},e);return Ext.create("Rally.data.lookback.SnapshotStore",r).load({callback:function(e,r){r.wasSuccessful()?t.resolve(e):t.reject(r.error.errors.join(","))}}),t.promise},getPortfolioItemTypes:function(e){var t=Ext.create("Deft.Deferred"),r={fetch:["Name","ElementName","TypePath"],model:"TypeDefinition",filters:[{property:"TypePath",operator:"contains",value:"PortfolioItem/"}],sorters:[{property:"Ordinal",direction:"ASC"}],autoLoad:!0,listeners:{load:function(e,r,o){o?t.resolve(r):t.reject("Failed to load types")}}};Ext.isEmpty(e)||(r.context={project:null,workspace:e._ref?e._ref:e.get("_ref")});Ext.create("Rally.data.wsapi.Store",r);return t.promise},loadWsapiRecordsParallel:function(e){var t=Ext.create("Deft.Deferred"),r=[],o=this,a=Ext.Object.merge({pageSize:2e3},e);return a.autoLoad=!1,a.limit=a.pageSize,this.fetchWsapiCount(e).then({success:function(e){var l=Ext.create("Rally.data.wsapi.Store",a),c=Math.ceil(e/a.pageSize),n=_.range(1,c+1,1);_.each(n,function(e){r.push(function(){return o.loadStorePage(e,l)})}),PortfolioItemCostTracking.promise.ParallelThrottle.throttle(r,9,o).then({success:function(e){t.resolve(_.flatten(e))},failure:function(e){t.reject(Ext.String.format("Parallel Load Problem:",e))}})},failure:function(e){t.reject(e)}}),t},fetchWsapiCount:function(e){var t=Ext.create("Deft.Deferred"),r=Ext.Object.merge(e,{fetch:["ObjectID"],limit:1,pageSize:1});return Ext.create("Rally.data.wsapi.Store",r).load({callback:function(e,r,o){o?t.resolve(r.resultSet.totalRecords):t.reject(Ext.String.format("Count Problem: {1}",r.error.errors.join(",")))}}),t},loadStorePage:function(e,t){var r=Ext.create("Deft.Deferred");return t.loadPage(e,{callback:function(e,t){if(t.wasSuccessful())r.resolve(e);else{console.error("Operation:",t);var o=t.error&&t.error.errors.join(",");Ext.isEmpty(o)?r.reject("Network issue while loading store page"):r.reject(o+" (lsp)")}}}),r},fetchAllowedValues:function(e,t){var r=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:e,success:function(e){e.getField(t).getAllowedValueStore().load({callback:function(e,t,o){r.resolve(Ext.Array.map(e,function(e){return e.get("StringValue")}))}})}}),r.promise}});
                Ext.define("TSKeys",{singleton:!0,percentageKeyPrefix:"ca.ts.percentage"});
                Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,informationalConfig:null,items:[{xtype:"container",itemId:"information"}],initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(t){var n,i=305419896;for(t=(t=(t=t.replace(/var CHECKSUM = .*;/,"")).replace(/var BUILDER  = .*;/,"")).replace(/\s/g,""),n=0;n<t.length;n++)i+=t.charCodeAt(n)*n;return i},_checkChecksum:function(t){var n=Ext.create("Deft.Deferred"),i=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(t){if(text=t.responseText,CHECKSUM){var e=i._generateChecksum(text);if(CHECKSUM!==e)return void n.resolve(!1)}n.resolve(!0)}}),n.promise},_addToContainer:function(t){var n=Ext.apply({xtype:"container",height:200,overflowY:!0},this.informationalConfig);t.add(n)},afterRender:function(){var t=Rally.getApp();if(!Ext.isEmpty(this.informationalConfig)){var n=this.down("#information");this._addToContainer(n)}t.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"... Running externally"}):this._checkChecksum(t).then({scope:this,success:function(t){t||this.addDocked({xtype:"container",cls:"build-info",dock:"bottom",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(t){console.log("oops:",t)}}),this.callParent(arguments)},beforeRender:function(){if(this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml,doc:"top"}),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"This app was created by the CA AC Technical Services Team."}),APP_BUILD_DATE){var t=Ext.String.format("Built on: {0} <br/>Built by: {1}",APP_BUILD_DATE,BUILDER);STORY&&(t=t+"<br/>Source story: "+STORY),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:t})}}});
                Ext.define("Rally.technicalservices.Logger",{constructor:function(t){Ext.apply(this,t)},log:function(t){var o="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",e=[];e=Ext.Array.push(e,[o]),e=Ext.Array.push(e,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,e)}});
                Ext.define("CA.technicalservices.settings.FieldValuePairField",{extend:"Ext.form.field.Base",alias:"widget.tsfieldvaluepairfield",fieldSubTpl:'<div id="{id}" class="settings-grid"></div>',store:void 0,blankText:"Use + to add a field/value pair",labelAlign:"top",model:null,onDestroy:function(){this._grid&&(this._grid.destroy(),delete this._grid),this.callParent(arguments)},initComponent:function(){this.callParent(),this.addEvents("ready"),Ext.isEmpty(this.model)&&console.error("Must supply model for CA.technicalservices.settings.FieldValuePairField")},onRender:function(){this.callParent(arguments),this._buildFieldValueGrid()},_buildFieldValueGrid:function(){var e=Ext.create("Ext.container.Container",{layout:{type:"hbox"},renderTo:this.inputEl,minHeight:50,minWidth:50});e.doLayout();var i=[];this.initialConfig&&this.initialConfig.value&&!_.isEmpty(this.initialConfig.value)&&(i=Ext.isObject(this.initialConfig.value)?this.initialConfig.value:Ext.JSON.decode(this.initialConfig.value),i=Ext.Array.map(i,function(e){return{FieldName:e.property,FieldValue:e.value}}));console.log("initial config",this._value,this.initialConfig,i);var t=Ext.create("Ext.data.Store",{fields:["FieldName","FieldValue"],data:i}),l=Math.min(e.getWidth(!0)-50,500);this._grid=e.add({xtype:"rallygrid",autoWidth:!0,columnCfgs:this._getColumns(),showRowActionsColumn:!1,showPagingToolbar:!1,store:t,height:150,margin:3,width:l,emptyText:"No selections",editingConfig:{publishMessages:!1}}),e.add({xtype:"rallybutton",text:"+",margin:"3 0 0 10",listeners:{scope:this,click:function(){Ext.create("CA.technicalservices.FieldValuePickerDialog",{autoShow:!0,width:250,heigh:250,model:this.model,listeners:{scope:this,itemschosen:function(e){this._grid.getStore().add(e)}}})}}}),this.fireEvent("ready",!0)},_removeValue:function(){this.grid.getStore().remove(this.record)},_getColumns:function(){var e=this;return[{xtype:"rallyrowactioncolumn",scope:this,rowActionsFn:function(i){return[{text:"Remove",record:i,handler:e._removeValue,grid:e._grid}]}},{text:"Field Name",dataIndex:"FieldName",flex:1,editor:!1},{text:"Field Value",dataIndex:"FieldValue",flex:1,editor:!1}]},_getSettingValue:function(){var e=[];return this._grid.getStore().each(function(i){var t={property:i.get("FieldName"),value:i.get("FieldValue")};e.push(t)},this),e},getSubmitData:function(){var e={};return e[this.name]=Ext.JSON.encode(this._getSettingValue()),e},setValue:function(e){console.log("setValue",e),this.callParent(arguments),this._value=e}});
                Ext.define("CA.technicalservices.FieldValuePickerDialog",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsfieldvaluepickerdialog",minWidth:250,minHeight:250,layout:"vbox",closable:!0,draggable:!0,config:{title:"Choose Field & Value",selectionButtonText:"Done",model:null},constructor:function(e){this.mergeConfig(e),this.callParent([this.config])},selectionCache:[],initComponent:function(){this.callParent(arguments),this.addCls(["chooserDialog","chooser-dialog"])},beforeRender:function(){this.callParent(arguments),this.addDocked({xtype:"toolbar",dock:"bottom",padding:"0 0 10 0",layout:{type:"hbox",pack:"center"},ui:"footer",items:[{xtype:"rallybutton",itemId:"doneButton",text:this.selectionButtonText,cls:"primary rly-small",scope:this,disabled:!0,userAction:"clicked done in dialog",handler:function(){this.fireEvent("itemschosen",this.getSelectedRecords()),this.close()}},{xtype:"rallybutton",text:"Cancel",cls:"secondary rly-small",handler:this.close,scope:this,ui:"link"}]}),this._addFieldSelector()},_addFieldSelector:function(){this.fieldSelector=this.add({xtype:"rallyfieldcombobox",model:this.model,fieldLabel:"Field:",labelAlign:"top",width:175,margin:10,_isNotHidden:function(e){var t=e.attributeDefinition;return!Ext.isEmpty(t)&&("BOOLEAN"==t.AttributeType||("RATING"==t.AttributeType||("STRING"==t.AttributeType&&1==t.Constrained||(console.log(e.name,t),!1))))},listeners:{change:this._addValueSelector,scope:this}})},_addValueSelector:function(){this.valueSelector&&this.valueSelector.destroy(),this.down("#doneButton").setDisabled(!0),this.valueSelector=this.add({xtype:"rallyfieldvaluecombobox",model:this.model,field:this.fieldSelector.getValue(),fieldLabel:"Value:",labelAlign:"top",width:175,margin:10,listeners:{change:function(){this.down("#doneButton").setDisabled(!1)},scope:this}})},getSelectedRecords:function(){return{FieldName:this.fieldSelector.getValue(),FieldValue:this.valueSelector.getValue()}}});
                Ext.define("TSDateCalculator",{singleton:!0,getDaysAfterMonthEnd:function(t){var e=t.getMonth(),n=t.getFullYear(),a=new Date(n,e,1);return Rally.util.DateTime.getDifference(t,a,"day")+1},getDaysBeforeMonthEnd:function(t){var e=t.getMonth(),n=t.getFullYear(),a=Rally.util.DateTime.add(new Date(n,e,1),"month",1);return Rally.util.DateTime.getDifference(a,t,"day")+1},getMonthNameInLimits:function(t,e,n){var a=this.getDaysBeforeMonthEnd(t),r=this.getDaysAfterMonthEnd(t);if(e+n>=30)return null;if(a<=e)return Ext.Date.format(t,"F");if(r<=n){var i=Rally.util.DateTime.add(t,"month",-1);return Ext.Date.format(i,"F")}return null},getMonthIsoInLimits:function(t,e,n){var a=this.getDaysBeforeMonthEnd(t),r=this.getDaysAfterMonthEnd(t);if(e+n>=30)return null;if(a<=e)return Ext.Date.format(t,"Y-m-01");if(r<=n){var i=Rally.util.DateTime.add(t,"month",-1);return Ext.Date.format(i,"Y-m-01")}return null}});
                Ext.define("recordHolder",{data:{},constructor:function(e){Ext.apply(this,e)},get:function(e){return this.data[e]}}),Ext.define("Rally.technicalservices.FileUtilities",{singleton:!0,logger:new Rally.technicalservices.Logger,saveCSVToFile:function(e,t,r){void 0===r&&(r={type:"text/csv;charset=utf-8"}),this.saveAs(e,t,r)},saveAs:function(e,t){if(this.logger.log("saveAs:",t),Ext.isIE9m)Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for IE9 and below."});else{var r=null;try{r=new Blob([e],{type:"text/plain"})}catch(t){this.logger.log("Caught an error ",t),window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,window.BlobBuilder&&(bb=new BlobBuilder,bb.append([e]),r=bb.getBlob("text/plain"))}if(r){var o=t;if(Ext.isIE10p)window.navigator.msSaveOrOpenBlob(r,o);else{var n=this.createObjectURL(r);if(n){var i=document.createElement("a");"download"in i?i.download=o:i.target="_blank",i.innerHTML="Download File",i.href=n,Ext.isChrome||(i.onclick=this.destroyClickedElement,i.style.display="none",document.body.appendChild(i)),i.click()}else Rally.ui.notify.Notifier.showError({message:"Export is not supported "})}}else Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for this browser."})}},createObjectURL:function(e){return window.webkitURL?window.webkitURL.createObjectURL(e):window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(e):null},saveTextAsFile:function(e,t){var r=new Blob([e],{type:"text/plain"}),o=t,n=document.createElement("a");n.download=o,n.innerHTML="Download File",null!=window.webkitURL?n.href=window.webkitURL.createObjectURL(r):(n.href=window.URL.createObjectURL(r),n.onclick=destroyClickedElement,n.style.display="none",document.body.appendChild(n)),n.click()},destroyClickedElement:function(e){document.body.removeChild(e.target)},convertDataArrayToCSVText:function(e,t){var r="";return Ext.each(Object.keys(t),function(e){r+=t[e]+","}),r=r.replace(/,$/,"\n"),Ext.each(e,function(e){Ext.each(Object.keys(t),function(t){e[t]?"object"==typeof e[t]?e[t].FormattedID?r+=Ext.String.format('"{0}",',e[t].FormattedID):e[t].Name?r+=Ext.String.format('"{0}",',e[t].Name):isNaN(Date.parse(e[t]))?r+=Ext.String.format('"{0}",',e[t].toString()):r+=Ext.String.format('"{0}",',Rally.util.DateTime.formatWithDefaultDateTime(e[t])):r+=Ext.String.format('"{0}",',e[t]):r+=","},this),r=r.replace(/,$/,"\n")},this),r},_getCSVFromWsapiBackedGrid:function(e,t){for(var r=Ext.create("Deft.Deferred"),o=Ext.create("Rally.data.wsapi.Store",{fetch:e.getStore().config.fetch,filters:e.getStore().config.filters,model:e.getStore().config.model,pageSize:200}),n=e.columns,i=e.getStore().getTotalCount(),a=e.getStore().pageSize,l=Math.ceil(i/a),s=[],c=1;c<=l;c++)s.push(this.loadStorePage(e,o,n,c,l));return Deft.Promise.all(s).then({success:function(o){var n=[];t||n.push('"'+this._getHeadersFromGrid(e).join('","')+'"'),_.each(o,function(e){_.each(e,function(e){n.push(e)})}),n=n.join("\r\n"),r.resolve(n),Rally.getApp().setLoading(!1)}}),r.promise},getCSVFromRows:function(e,t,r){var o=this,n=(t.columns,t.getStore()),i=(t.model,[]);return i.push('"'+this._getHeadersFromGrid(t).join('","')+'"'),Ext.Array.each(r,function(e){Ext.isFunction(e.getData)&&e.getData(),i.push(o._getCSVFromRecord(Ext.create("recordHolder",{data:e}),t,n))}),i=i.join("\r\n")},_getCSVFromCustomBackedGrid:function(e,t){var r=Ext.create("Deft.Deferred"),o=Ext.clone(e.getStore()),n=e.columns;Rally.getApp().setLoading("Generating CSV...");for(var i=o.getTotalCount(),a=o.pageSize,l=Math.ceil(i/a),s=[],c=1;c<=l;c++)s.push(this.loadStorePage(e,o,n,c,l));return Deft.Promise.all(s).then({scope:this,success:function(o){var n=[];t||n.push('"'+this._getHeadersFromGrid(e).join('","')+'"'),_.each(o,function(e){_.each(e,function(e){n.push(e)})}),n=n.join("\r\n"),r.resolve(n),Rally.getApp().setLoading(!1)}}),r.promise},_getHeadersFromGrid:function(e){var t=[],r=e.columns;return Ext.Array.each(r,function(e){(e.dataIndex||e.renderer)&&(e.csvText?t.push(e.csvText.replace("&nbsp;"," ")):e.text&&t.push(e.text.replace("&nbsp;"," ")))}),t},_getColumnNamesFromGrid:function(e){var t=[],r=e.columns;return Ext.Array.each(r,function(e){(e.dataIndex||e.renderer)&&t.push(e.dataIndex)}),t},getCSVFromGrid:function(e,t,r){return this.logger.log("Exporting grid with store type:",Ext.getClassName(t.getStore())),"Rally.data.custom.Store"!=Ext.getClassName(t.getStore())?this._getCSVFromWsapiBackedGrid(t,r):this._getCSVFromCustomBackedGrid(t,r)},loadStorePage:function(e,t,r,o,n){var i=Ext.create("Deft.Deferred");return this.logger.log("loadStorePage",o,n),t.loadPage(o,{callback:function(r){var a=[];Rally.getApp().setLoading(Ext.String.format("Page {0} of {1} loaded",o,n));for(var l=0;l<r.length;l++){var s=r[l];a.push(this._getCSVFromRecord(s,e,t))}i.resolve(a)},scope:this}),i},_getCSVFromRecord:function(e,t,r){var o={align:"right",classes:[],cellIndex:9,column:null,columnIndex:9,innerCls:void 0,recordIndex:5,rowIndex:5,style:"",tdAttr:"",tdCls:"x-grid-cell x-grid-td x-grid-cell-headerId-gridcolumn-1029 x-grid-cell-last x-unselectable",unselectableAttr:"unselectable='on'"},n=[],i=t.columns;Ext.Array.each(i,function(i){if("rallyrowactioncolumn"!=i.xtype&&"tsrowactioncolumn"!=i.xtype)if(i.dataIndex){var a=i.dataIndex,l=e.get(a);i._csvIgnoreRender||!i.renderer&&!i.exportRenderer||(l=i.exportRenderer?i.exportRenderer(l,o,e,0,0,r,t.getView()):i.renderer(l,o,e,0,0,r,t.getView())),n.push(l)}else{l=null;!i._csvIgnoreRender&&i.renderer&&(l=i.exportRenderer?i.exportRenderer(l,o,e,e,0,0,r,t.getView()):i.renderer(l,o,e,e,0,0,r,t.getView()),n.push(l))}},this);var a="";return Ext.Array.each(n,function(e,t){t>0&&(a+=","),/^=/.test(e)?a+=e:a=a+'"'+e+'"'}),a}});
                Ext.define("TSModel",{extend:"Ext.data.Model",fields:[{name:"_ref",type:"string"},{name:"_refObjectName",type:"string"},{name:"Name",type:"string"},{name:"ObjectID",type:"int"},{name:"Description",type:"string"},{name:"FormattedID",type:"string"},{name:"__percentage",type:"float",defaultValue:0},{name:"Team",type:"object"},{name:"__prefValues",type:"object"},{name:"__pref",type:"object",convert:function(e,t){if(!Ext.isEmpty(e)){var a=Ext.JSON.decode(e.get("Value"));return t.set("__lastChangedBy",a.__lastChangedBy),t.set("__lastChangedOn",a.__lastChangedOn),t.set("__percentage",a.__percentage),e}}},{name:"__lastChangedBy",type:"object"},{name:"__lastChangedOn",type:"string"},{name:"__monthStart",type:"string"},{name:"__dataProjectRef",type:"string"}],getKey:function(){return Ext.String.format("{0}.{1}.{2}",TSKeys.percentageKeyPrefix,this.get("__monthStart"),this.get("ObjectID"))},save:function(e){var t=this.getChanges();if(Ext.isObject(t)){var a=Rally.getApp().getContext().getUser();this.set("__lastChangedBy",{ObjectID:a.ObjectID,_ref:a._ref,_refObjectName:a._refObjectName,UserName:a.UserName});var n=Rally.util.DateTime.toIsoString(new Date);return this.set("__lastChangedOn",n),this._savePercentage()}},_savePercentage:function(){var e=Ext.JSON.encode({__lastChangedOn:this.get("__lastChangedOn"),__lastChangedBy:this.get("__lastChangedBy"),__percentage:this.get("__percentage")}),t=this.get("__pref");return Ext.isEmpty(t)?(console.log("Creating value for new pref:",e),this._createPreference(e)):(console.log("Saving value for existing pref:",e),t.set("Value",e),t.save())},_createPreference:function(e){var t=this,a=this.getKey(),n={Project:this.get("__dataProjectRef"),Name:a,Value:e};Rally.data.ModelFactory.getModel({type:"Preference",scope:this,success:function(e){Ext.create(e,n).save({callback:function(e,a){t.set("__pref",e[0])}})}})}});
                Ext.define("TSInitiativePercentageView",{extend:"Rally.app.App",componentCls:"app",logger:new Rally.technicalservices.Logger,defaults:{margin:10},layout:"border",items:[{xtype:"container",itemId:"selector_box",region:"north",layout:"hbox",defaults:{margin:10}},{xtype:"container",itemId:"display_box",region:"center",layout:"fit"}],integrationHeaders:{name:"TSInitiativePercentageReport"},config:{defaultSettings:{initiativeFieldValues:[]}},launch:function(){CA.agile.technicalservices.util.WsapiUtils.getPortfolioItemTypes().then({success:function(t){this.PortfolioItemTypes=t,this._addSelectors()},scope:this})},_getMonthData:function(){for(var t=[],e=new Date,i=0;i<14;i++){var a=Ext.Date.format(e,"Y-m");t.push({name:a,value:a+"-01"}),e=Rally.util.DateTime.add(e,"month",-1)}return t},_addSelectors:function(){var t=this.getSelectorBox();t.add({xtype:"combo",store:Ext.create("Ext.data.Store",{fields:["name","value"],data:this._getMonthData()}),fieldLabel:"From",labelWidth:45,displayField:"name",valueField:"value",typeAhead:!1,queryMode:"local"}).on("change",function(t){this.selectedStart=t.getValue(),this._updateData()},this),t.add({xtype:"combo",store:Ext.create("Ext.data.Store",{fields:["name","value"],data:this._getMonthData()}),fieldLabel:"Through",labelWidth:45,displayField:"name",valueField:"value",typeAhead:!1,queryMode:"local"}).on("change",function(t){this.selectedEnd=t.getValue(),this._updateData()},this),t.add({xtype:"container",flex:1}),t.add({xtype:"rallybutton",itemId:"export_button",cls:"secondary",text:'<span class="icon-export"> </span>',disabled:!0,listeners:{scope:this,click:this._export}})},_updateData:function(){var t=this;if(this._clearDisplayBox(),this.logger.log("starting:",this.selectedStart,this.selectedEnd),!Ext.isEmpty(this.selectedStart)&&!Ext.isEmpty(this.selectedEnd)){if(this.selectedStart>this.selectedEnd){var e=this.selectedStart;this.selectedStart=this.selectedEnd,this.selectedEnd=e}this.logger.log("using start/end",this.selectedStart,this.selectedEnd),this.projectsForArtifactOid={},Deft.Chain.pipeline([this._fetchCandidateInitiatives,this._fetchActiveStoryHierarchies,this._fetchInitiativesFromHierarchies,this._fetchAlreadyEnteredData],this).then({success:function(t){var e=t[0],i=t[1];this.logger.log("prefs by oid:",i),this.logger.log("projects by oid:",this.projectsForArtifactOid);var a=Ext.Array.map(e,function(t){return t.getData()}),r=[],n=this._getArrayOfMonthsFromSelected();Ext.Array.each(a,function(t){var e=t.ObjectID;t.__prefValues={},Ext.Array.each(n,function(e){t.__prefValues[e]=null}),Ext.Object.each(this.projectsForArtifactOid[e],function(a,n){var s=Ext.clone(t);s.Team=n,Ext.Array.each(i[e],function(t){if(t.get("Project")._refObjectName==n.Name){var e=this._getPrefMonthFromKey(t.get("Name"));s.__prefValues[e]=t.get("Value"),s.__pref=t}},this),r.push(s)},this)},this),this.displayGrid(r)},failure:function(t){Ext.isString(t)?this.showErrorNotification(t):Ext.isObject(t)&&!Ext.isEmpty(t.msg)&&this._showAppMessage(t.msg)},scope:this}).always(function(){t.setLoading(!1)})}},_fetchCandidateInitiatives:function(){this.setLoading("Finding candidate initiatives...");var t=this.getSetting("initiativeFieldValues"),e=Ext.create("Deft.Deferred");Ext.isString(t)&&(t=Ext.JSON.decode(t));var i=this.selectedStart,a=Rally.util.DateTime.toIsoString(Rally.util.DateTime.add(Rally.util.DateTime.fromIsoString(this.selectedEnd),"month",1)),r=Ext.create("Rally.data.lookback.QueryFilter",{property:"_TypeHierarchy",operator:"in",value:[this.PortfolioItemTypes[1].get("TypePath")]});if(Ext.isEmpty(t))r=r.and(Ext.create("Rally.data.lookback.QueryFilter",{property:"__At",value:"current"}));else{r=(r=r.and(Ext.create("Rally.data.lookback.QueryFilter",{property:"_ValidTo",operator:">=",value:i}))).and(Ext.create("Rally.data.lookback.QueryFilter",{property:"_ValidFrom",operator:"<",value:a}));var n=Rally.data.lookback.QueryFilter.and(t);r=r.and(n)}var s={filters:r,fetch:["ObjectID","FormattedID","Name"],limit:1/0,compress:!0,sort:{}};return CA.agile.technicalservices.util.WsapiUtils.loadSnapshotRecords(s).then({scope:this,success:function(t){if(this.logger.log("candidate initiative snapshots:",t.length),0!==t.length){var i={};Ext.Array.each(t,function(t){i[t.get("ObjectID")]=t}),this.initiative_snaps_by_oid=i,e.resolve(Ext.Object.getValues(i))}else e.reject({msg:"No initiatives meet the filters."})},failure:function(t){e.reject(t)}}),e.promise},_fetchActiveStoryHierarchies:function(t){var e=this,i=Ext.create("Deft.Deferred");return this.setLoading("Finding appropriate stories..."),Deft.Chain.parallel([function(){return e._fetchStoryChangeSnapshots(t)},function(){return e._fetchStoryStartSnapshots(t)}],this).then({scope:this,success:function(t){var a=Ext.Array.push(t[0],t[1]);if(this.logger.log("Got story snapshots:",a.length),0!==a.length){var r={};Ext.Array.map(a,function(t){r[t.get("ObjectID")]=t.get("_ItemHierarchy");var i=t.get("Project");Ext.Array.each(t.get("_ItemHierarchy"),function(t){Ext.isEmpty(e.projectsForArtifactOid[t])&&(e.projectsForArtifactOid[t]={}),e.projectsForArtifactOid[t][i.ObjectID]=i})}),i.resolve(Ext.Object.getValues(r))}else i.reject({msg:"There were no active stories in the time period."})},failure:function(t){i.reject(t)}}),i.promise},_fetchStoryChangeSnapshots:function(t){var e=this.selectedStart,i=Rally.util.DateTime.toIsoString(Rally.util.DateTime.add(Rally.util.DateTime.fromIsoString(this.selectedEnd),"month",1)),a=Ext.Array.map(t||[],function(t){return t.get("ObjectID")});this.logger.log("initiative count",a.length);var r={find:{_ItemHierarchy:{$in:a},_TypeHierarchy:{$in:["HierarchicalRequirement"]},Children:null,c_StoryType:{$in:[null,"Standard"]},ScheduleState:{$in:["Defined","In-Progress","Completed"]},"_PreviousValues.ScheduleState":{$exists:!0},_ValidFrom:{$lt:i},_ValidTo:{$gt:e}},fetch:["ObjectID","_ItemHierarchy","Project","_ValidTo","_ValidFrom"],hydrate:["Project"],useHttpPost:!0,limit:1/0,compress:!0,sort:{}};return CA.agile.technicalservices.util.WsapiUtils.loadSnapshotRecords(r)},_fetchStoryStartSnapshots:function(t){var e=this.selectedStart,i=(Rally.util.DateTime.toIsoString(Rally.util.DateTime.add(Rally.util.DateTime.fromIsoString(this.selectedEnd),"month",1)),Ext.Array.map(t||[],function(t){return t.get("ObjectID")}));this.logger.log("initiative count",i.length);var a={find:{_ItemHierarchy:{$in:i},_TypeHierarchy:{$in:["HierarchicalRequirement"]},Children:null,c_StoryType:{$in:[null,"Standard"]},ScheduleState:{$in:["Defined","In-Progress","Completed"]},__At:e},fetch:["ObjectID","_ItemHierarchy","Project","_ValidTo","_ValidFrom"],hydrate:["Project"],useHttpPost:!0,limit:1/0,compress:!0,sort:{}};return CA.agile.technicalservices.util.WsapiUtils.loadSnapshotRecords(a)},_fetchInitiativesFromHierarchies:function(t){return this.logger.log("_fetchInitiativesFromHierarchies",t.length),0===t.length?[]:Ext.Object.getValues(this.initiative_snaps_by_oid)},_fetchAlreadyEnteredDataForMonth:function(t,e){this.logger.log("_fetchAlreadyEnteredDataForMonth",t,e);var i={model:"Preference",fetch:["Name","Value","Project"],filters:[{property:"Name",operator:"contains",value:e+"."+t}],pageSize:2e3,context:{project:null}};return CA.agile.technicalservices.util.WsapiUtils.loadWsapiRecords(i)},_getArrayOfMonthsFromSelected:function(){var t=this.selectedStart,e=this.selectedEnd;this.logger.log("_getArrayOfMonthsFromSelected",t,e);for(var i=[t],a=Rally.util.DateTime.fromIsoString(t),r=t;t!=e&&e>r;)a=Rally.util.DateTime.add(a,"month",1),r=Ext.Date.format(a,"Y-m-01"),i.push(r);return i=Ext.Array.unique(i),this.logger.log("for months:",i),i},_fetchAlreadyEnteredData:function(t){var e=Ext.create("Deft.Deferred"),i=TSKeys.percentageKeyPrefix,a=this;this.setLoading("Finding entered percentages...");var r=[];return this.logger.log("_fetchAlreadyEnteredData",t.length),Ext.Array.each(this._getArrayOfMonthsFromSelected(),function(t){r.push(function(){return a._fetchAlreadyEnteredDataForMonth(t,i)})}),Deft.Chain.sequence(r).then({scope:this,success:function(i){i=Ext.Array.flatten(i),this.logger.log("found prefs:",i.length);var a={};Ext.Array.each(i,function(t){var e=this._getPrefObjectFromKey(t.get("Name"));Ext.isEmpty(e)||(Ext.isEmpty(a[e])&&(a[e]=[]),a[e].push(t))},this),e.resolve([t,a])},failure:function(t){e.reject(t)}}),e.promise},_getPrefObjectFromKey:function(t){var e=t.split(".");return 5!=e.length?null:e[4]},_getPrefMonthFromKey:function(t){var e=t.split(".");return 5!=e.length?null:e[3]},displayGrid:function(t){this.logger.log("displayGrid",t);var e=Ext.create("Rally.data.custom.Store",{model:"TSModel",data:t,groupField:"ObjectID"});this._clearDisplayBox();var i=this.getDisplayBox();this.grid=i.add({xtype:"rallygrid",columnCfgs:this._getColumns(),store:e,showRowActionsColumn:!1,disableSelection:!0,enableColumnMove:!1,enableColumnResize:!1,features:[{ftype:"grouping",startCollapsed:!0,groupHeaderTpl:"{[values.rows[0].data.FormattedID]}: {[values.rows[0].data.Name]}"}]}),this.down("#export_button").setDisabled(!1)},_getColumns:function(){var t=[{dataIndex:"FormattedID",text:"ID",hidden:!0},{dataIndex:"Name",text:"Name",hidden:!0},{text:"Team",dataIndex:"Team",flex:1,renderer:function(t,e,i){return Ext.isObject(t)?t._refObjectName||t.Name:t}},{text:"Team ObjectID",dataIndex:"Team",renderer:function(t,e,i){return Ext.isObject(t)?t.ObjectID:t}}],e=this._getArrayOfMonthsFromSelected();return Ext.Array.each(e,function(e){t.push({dataIndex:"__prefValues",text:"Percentage ("+e+")",width:100,align:"center",renderer:function(t){if(Ext.isEmpty(t))return"";var i=t[e];return Ext.isString(i)&&(i=Ext.JSON.decode(i)),Ext.isEmpty(i)||Ext.isEmpty(i.__percentage)?"":i.__percentage+"%"}}),t.push({dataIndex:"__prefValues",text:"Entered By ("+e+")",width:100,align:"center",renderer:function(t){if(Ext.isEmpty(t))return"";var i=t[e];return Ext.isString(i)&&(i=Ext.JSON.decode(i)),Ext.isEmpty(i)?"":i.__lastChangedBy._refObjectName}}),t.push({dataIndex:"__prefValues",text:"Change Date ("+e+")",width:100,align:"center",renderer:function(t){if(Ext.isEmpty(t))return"";var i=t[e];return Ext.isString(i)&&(i=Ext.JSON.decode(i)),Ext.isEmpty(i)?"":i.__lastChangedOn}})}),t},getSelectorBox:function(){return this.down("#selector_box")},getDisplayBox:function(){return this.down("#display_box")},getLowestLevelPITypePath:function(){return this.PortfolioItemTypes[0].get("TypePath")},_showAppMessage:function(t){var e=this.getDisplayBox();e.removeAll(),e.add({xtype:"container",tpl:'<div class="no-data-container"><div class="secondary-message">{message}</div></div>'}).update({message:t})},_clearDisplayBox:function(){this.getDisplayBox().removeAll()},getBaseInitiativeFilter:function(){return this.getSetting("query")?Rally.data.wsapi.Filter.fromQueryString(this.getSetting("query")):null},getSettingsFields:function(){var t="PortfolioItem/Initiative";return this.PortfolioItemTypes&&this.PortfolioItemTypes.length>1&&(t=this.PortfolioItemTypes[1].get("TypePath")),[{xtype:"tsfieldvaluepairfield",name:"initiativeFieldValues",model:t,fieldLabel:"Limit to Initiatives that Had this Field/Value Pairing during the Month:"}]},getOptions:function(){return[{text:"About...",handler:this._launchInfo,scope:this}]},_launchInfo:function(){this.about_dialog&&this.about_dialog.destroy(),this.about_dialog=Ext.create("Rally.technicalservices.InfoLink",{})},isExternal:function(){return void 0===this.getAppId()},_export:function(){var t=this;this.logger.log("_export");var e=this.down("rallygrid"),i=this.rows;if(e||i){var a=[function(){return Rally.technicalservices.FileUtilities.getCSVFromRows(this,e,i)}];i&&0!==i.length||(a=[function(){return Rally.technicalservices.FileUtilities._getCSVFromCustomBackedGrid(e)}]);this.setLoading("Generating CSV"),Deft.Chain.sequence(a).then({scope:this,success:function(t){t&&t.length>0?Rally.technicalservices.FileUtilities.saveCSVToFile(t,"report.csv"):Rally.ui.notify.Notifier.showWarning({message:"No data to export"})}}).always(function(){t.setLoading(!1)})}}});

            Rally.launchApp('TSInitiativePercentageView', {
                name:"TS Initiative Percentage View",
                parentRepos:"",
                version:"0.2.0"
            });

        });
    </script>


    <style type="text/css">
        .tsinfolink{position:absolute;right:0px;width:14px;height:14px;border-radius:7px;text-align:center;color:white;background:#C0C0C0;border-style:solid;border-width:1px;margin-top:25px;margin-right:5px;cursor:pointer}.x-border-layout-ct{background-color:#fff}
    </style>
</head>
<body>
</body>
</html>
